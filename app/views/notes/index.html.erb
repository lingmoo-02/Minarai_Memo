<% if flash[:notice] %>
  <div class="mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded"><%= notice %></div>
<% end %>
<h1 class="text-4xl text-center p-4 font-bold">ノート一覧</h1>

<!-- 検索フォーム -->
<div class="container mx-auto px-4 mb-6">
  <%= form_with url: notes_path, method: :get, local: true,
                class: "bg-white shadow-md rounded-lg p-4 md:p-6",
                data: { controller: "search-filter" } do |f| %>

    <!-- キーワード検索と詳細フィルタボタン（横並び） -->
    <div class="flex gap-2 mb-3">
      <div class="form-control flex-1">
        <label class="label">
          <span class="label-text font-semibold">キーワード検索</span>
        </label>
        <%= f.text_field :keyword,
            value: params[:keyword],
            placeholder: "タイトル、資材、反省点から検索",
            class: "input input-bordered w-full" %>
      </div>

      <div class="form-control flex-shrink-0 self-end">
        <button type="button"
                data-search-filter-target="toggleButton"
                data-action="click->search-filter#toggle"
                class="btn btn-outline btn-square"
                aria-expanded="false"
                aria-controls="filter-panel"
                title="詳細フィルタ">
          <i class="fas fa-sliders text-lg" data-search-filter-target="toggleIcon"></i>
        </button>
      </div>
    </div>

    <!-- 検索ボタン -->
    <div class="flex justify-center md:justify-end mb-3">
      <%= f.submit "検索", class: "btn btn-primary w-full md:w-auto" %>
    </div>

    <!-- 詳細フィルタパネル（デフォルト非表示） -->
    <div id="filter-panel"
         data-search-filter-target="filterPanel"
         class="hidden border-t border-gray-200 pt-4 mt-2 transition-all duration-300">

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <!-- タグフィルタ -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">タグ</span>
          </label>
          <%= f.select :tag_id,
              options_for_select(
                [["すべて", ""]] + Tag.where(team_id: nil).or(Tag.where(team_id: current_user.team_ids)).pluck(:name, :id),
                params[:tag_id]
              ),
              {},
              class: "select select-bordered w-full" %>
        </div>

        <!-- 開始日 -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">開始日</span>
          </label>
          <%= f.date_field :date_from,
              value: params[:date_from],
              class: "input input-bordered w-full" %>
        </div>

        <!-- 終了日 -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">終了日</span>
          </label>
          <%= f.date_field :date_to,
              value: params[:date_to],
              class: "input input-bordered w-full" %>
        </div>
      </div>

      <!-- クリアボタン -->
      <div class="flex justify-end">
        <%= link_to "クリア", notes_path, class: "btn btn-ghost btn-sm" %>
      </div>
    </div>
  <% end %>
</div>

<div class="container mx-auto px-4 mt-8">
  <!-- 検索結果表示 -->
  <% if params[:keyword].present? || params[:tag_id].present? || params[:date_from].present? || params[:date_to].present? %>
    <div class="mb-4 text-center text-sm text-gray-600">
      <%= "#{@notes.total_count}件のノートが見つかりました" %>
    </div>
  <% end %>

  <% if @notes.present? %>
    <!-- スマホ：リスト形式 -->
    <div class="block md:hidden space-y-4 pt-8 pb-8">
      <%= render @notes %>
    </div>

    <!-- PC：グリッド形式 -->
    <div class="hidden md:grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pt-8 pb-8">
      <%= render @notes %>
    </div>
  <% else %>
    <div class="mb-3 text-center">
      <% if params[:keyword].present? || params[:tag_id].present? || params[:date_from].present? || params[:date_to].present? %>
        検索条件に一致するノートが見つかりませんでした
      <% else %>
        ノートがありません
      <% end %>
    </div>
  <% end %>
  <%= paginate @notes %>
</div>
