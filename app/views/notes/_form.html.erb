<div class="max-w-2xl mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold text-center mb-6">
    ノートを<%= note.persisted? ? "編集" : "作成" %>する
  </h1>

  <%= form_with(model: note, local: true) do |form| %>
    <!-- エラーメッセージ -->
    <% if note.errors.any? %>
      <div role="alert" class="alert alert-error mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <h3 class="font-bold"><%= note.errors.count %> 件のエラーがあります</h3>
          <ul class="text-sm list-disc list-inside mt-2">
            <% note.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <!-- タイトル -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">タイトル</span>
      </label>
      <%= form.text_field :title,
          class: "input input-bordered w-full #{'input-error' if note.errors[:title].any?}",
          placeholder: "例：カンナでの仕上げ作業" %>
      <% if note.errors[:title].any? %>
        <label class="label">
          <span class="label-text-alt text-error"><%= note.errors[:title].first %></span>
        </label>
      <% end %>
    </div>

    <!-- 本文 -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">本文</span>
      </label>
      <%= form.text_area :body, rows: 5,
          class: "textarea textarea-bordered w-full #{'textarea-error' if note.errors[:body].any?}",
          placeholder: "学んだことやポイントを記録してください" %>
      <% if note.errors[:body].any? %>
        <label class="label">
          <span class="label-text-alt text-error"><%= note.errors[:body].first %></span>
        </label>
      <% end %>
    </div>

    <!-- 画像アップロード -->
    <div class="form-control" data-controller="image-preview">
      <label class="label">
        <span class="label-text font-semibold">完成写真</span>
        <span class="label-text-alt text-gray-500">任意（5MB以下）</span>
      </label>

      <!-- プレビューエリア -->
      <div class="flex justify-center mb-3">
        <!-- 既存画像（編集時のみ表示） -->
        <% if note.persisted? && note.note_image? %>
          <img src="<%= note.note_image_url %>"
               data-image-preview-target="currentImage"
               class="max-w-xs h-auto rounded-lg shadow-md" />
        <% end %>

        <!-- プレビュー画像（新規選択時に表示） -->
        <img data-image-preview-target="preview"
             class="max-w-xs h-auto rounded-lg shadow-md hidden" />

        <!-- プレースホルダー（画像未選択時） -->
        <div data-image-preview-target="placeholder"
             class="<%= 'hidden' if note.persisted? && note.note_image? %>">
          <img src="<%= asset_path('note_placeholder.png') %>"
               class="max-w-xs h-auto rounded-lg opacity-50" />
        </div>
      </div>

      <%= form.file_field :note_image,
          accept: "image/*",
          data: {
            image_preview_target: "input",
            action: "change->image-preview#previewImage"
          },
          class: "file-input file-input-bordered file-input-primary w-full" %>
      <%= form.hidden_field :note_image_cache %>

      <% if note.errors[:note_image].any? %>
        <label class="label">
          <span class="label-text-alt text-error"><%= note.errors[:note_image].first %></span>
        </label>
      <% end %>
    </div>

    <!-- チーム選択 -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">チーム</span>
        <span class="label-text-alt text-gray-500">任意</span>
      </label>
      <%= form.collection_select :team_id,
          current_user.joined_teams.order(:name), :id, :name,
          { prompt: "個人ノート" },
          {
            class: "select select-bordered w-full",
            data: {
              controller: "team-selector",
              action: "change->team-selector#updateTags"
            }
          } %>
    </div>

    <!-- タグ選択 -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">タグ</span>
        <span class="label-text-alt text-gray-500">任意</span>
      </label>
      <%= form.collection_select :tag_id,
          Tag.where(team_id: nil).order(:name), :id, :name,
          { prompt: "タグを選択（任意）" },
          {
            class: "select select-bordered w-full",
            data: { target: "team-selector.tagSelect" }
          } %>
    </div>

    <!-- 送信ボタン -->
    <div class="flex justify-center gap-4 mt-6">
      <%= form.submit note.persisted? ? "更新する" : "ノートを作成",
          class: "btn btn-primary btn-wide" %>
      <%= link_to "戻る", notes_path,
          class: "btn btn-ghost" %>
    </div>
  <% end %>
</div>
