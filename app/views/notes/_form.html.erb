<div class="max-w-2xl mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold text-center mb-6">
    ノートを<%= note.persisted? ? "編集" : "作成" %>する
  </h1>

  <%= form_with(model: note, local: true) do |form| %>
    <!-- エラーメッセージ -->
    <% if note.errors.any? %>
      <div role="alert" class="alert alert-error mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <h3 class="font-bold"><%= note.errors.count %> 件のエラーがあります</h3>
          <ul class="text-sm list-disc list-inside mt-2">
            <% note.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <!-- タイトル -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">タイトル</span>
      </label>
      <%= form.text_field :title,
          class: "input input-bordered w-full #{'input-error' if note.errors[:title].any?}",
          placeholder: "例：カンナでの仕上げ作業" %>
      <% if note.errors[:title].any? %>
        <label class="label">
          <span class="label-text-alt text-error"><%= note.errors[:title].first %></span>
        </label>
      <% end %>
    </div>

    <!-- 画像アップロード -->
    <div class="form-control" data-controller="image-preview">
      <label class="label">
        <span class="label-text font-semibold">
          完成写真
          <% unless note.persisted? %>
            <span class="text-error">*</span>
          <% end %>
        </span>
      </label>

      <!-- プレビューエリア -->
      <div class="flex justify-center mb-3">
        <!-- 既存画像（編集時のみ表示） -->
        <% if note.persisted? && note.note_image? %>
          <img src="<%= note.note_image_url %>"
               data-image-preview-target="currentImage"
               class="max-w-xs h-auto rounded-lg shadow-md" />
        <% end %>

        <!-- プレビュー画像（新規選択時に表示） -->
        <img data-image-preview-target="preview"
             class="max-w-xs h-auto rounded-lg shadow-md hidden" />

        <!-- プレースホルダー（画像未選択時） -->
        <div data-image-preview-target="placeholder"
             class="<%= 'hidden' if note.persisted? && note.note_image? %>">
          <img src="<%= asset_path('note_placeholder.png') %>"
               class="max-w-xs h-auto rounded-lg opacity-50" />
        </div>
      </div>

      <div class="flex justify-center">
        <%= form.file_field :note_image,
            accept: "image/*",
            data: {
              image_preview_target: "input",
              action: "change->image-preview#previewImage"
            },
            class: "file-input file-input-bordered file-input-neutral" %>
        <%= form.hidden_field :note_image_cache %>
      </div>

      <% if note.errors[:note_image].any? %>
        <label class="label">
          <span class="label-text-alt text-error"><%= note.errors[:note_image].first %></span>
        </label>
      <% end %>
    </div>

    <!-- 使用した資材 -->
    <div class="form-control" data-controller="materials-select">
      <label class="label">
        <span class="label-text font-semibold">
          使用した資材
          <span class="text-error">*</span>
        </span>
      </label>

      <details class="dropdown dropdown-bottom w-full">
        <summary class="btn btn-outline w-full justify-start font-normal text-left #{'btn-error' if note.errors[:material].any?}">
          <span data-materials-select-target="materialLabel">選択するか入力してください</span>
        </summary>

        <ul class="dropdown-content menu bg-base-100 rounded-box z-1 w-full shadow-md p-2"
            data-materials-select-target="materialMenu">
          <li><a href="#" data-value="" data-action="click->materials-select#selectMaterial">
            --新規入力--
          </a></li>
        </ul>
      </details>

      <%= form.hidden_field :material_id, data: { materials_select_target: "materialId" } %>
      <%= form.text_field :material_name,
          class: "input input-bordered w-full mt-2 hidden #{'input-error' if note.errors[:material].any?}",
          placeholder: "資材名を入力してください",
          data: { materials_select_target: "customInput" } %>

      <% if note.errors[:material].any? %>
        <label class="label">
          <span class="label-text-alt text-error"><%= note.errors[:material].first %></span>
        </label>
      <% end %>
    </div>

    <!-- 作業時間 -->
    <div class="form-control" data-controller="work-duration">
      <div class="flex justify-between items-center">
        <label class="label p-0">
          <span class="label-text font-semibold">
            作業時間
            <span class="text-error">*</span>
          </span>
        </label>
        <span class="label-text-alt font-semibold" data-work-duration-target="display"></span>
      </div>
      <%= form.number_field :work_duration,
          min: 1,
          max: 480,
          class: "input input-bordered w-1/3 #{'input-error' if note.errors[:work_duration].any?}",
          type: "number",
          placeholder: "かかった時間（分）",
          data: {
            work_duration_target: "input",
            action: "input->work-duration#updateDisplay"
          } %>
      <% if note.errors[:work_duration].any? %>
        <label class="label">
          <span class="label-text-alt text-error"><%= note.errors[:work_duration].first %></span>
        </label>
      <% end %>
    </div>

    <!-- 反省点 -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">
          反省点
          <span class="text-error">*</span>
        </span>
      </label>
      <%= form.text_area :reflection, rows: 5,
          class: "textarea textarea-bordered w-full #{'textarea-error' if note.errors[:reflection].any?}",
          placeholder: "例：もっと丁寧に仕上げるべきだった" %>
      <% if note.errors[:reflection].any? %>
        <label class="label">
          <span class="label-text-alt text-error"><%= note.errors[:reflection].first %></span>
        </label>
      <% end %>
    </div>

    <!-- チーム選択 -->
    <div class="form-control" data-controller="team-selector">
      <label class="label">
        <span class="label-text font-semibold">チーム</span>
      </label>

      <details class="dropdown dropdown-bottom w-full">
        <summary class="btn btn-outline w-full justify-start font-normal text-left">
          <span data-team-selector-target="teamLabel">個人ノート</span>
        </summary>

        <ul class="dropdown-content menu bg-base-100 rounded-box z-1 w-full shadow-md p-2">
          <li><a href="#" data-value="" data-action="click->team-selector#selectTeam">個人ノート</a></li>
          <% current_user.joined_teams.order(:name).each do |team| %>
            <li><a href="#" data-value="<%= team.id %>" data-action="click->team-selector#selectTeam">
              <%= team.name %>
            </a></li>
          <% end %>
        </ul>
      </details>

      <%= form.hidden_field :team_id, data: { target: "team-selector.teamInput" } %>
    </div>

    <!-- タグ選択 -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">タグ</span>
      </label>

      <details class="dropdown dropdown-bottom w-full">
        <summary class="btn btn-outline w-full justify-start font-normal text-left">
          <span data-team-selector-target="tagLabel">タグを選択</span>
        </summary>

        <ul class="dropdown-content menu bg-base-100 rounded-box z-1 w-full shadow-md p-2"
            data-team-selector-target="tagMenu">
        </ul>
      </details>

      <%= form.hidden_field :tag_id, data: { target: "team-selector.tagInput" } %>
    </div>

    <!-- 送信ボタン -->
    <div class="flex justify-center gap-4 mt-6">
      <%= form.submit note.persisted? ? "更新する" : "ノートを作成",
          class: "btn btn-primary" %>
      <%= link_to "戻る", notes_path,
          class: "btn btn-ghost" %>
    </div>
  <% end %>
</div>
